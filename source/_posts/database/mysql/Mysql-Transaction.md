---
title: Mysql 事务
description: Mysql 事务
categories: 
- Database
- Mysql
---

> ⚠️ MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务，可以使用`show engines;`来查看服务器支持的引擎

## 事务的特性（ACID）

### 原子性(Atomicity)

一个事务是不可分割的工作单位，要么全部成功，要么全部撤销。

### 一致性(Consistency)

数据库正确地改变状态后，数据库的一致性约束没有被破坏。

### 隔离性(Isolation)

事务之间相互独立，互不干扰。

### 持久性(Durability)

事务的提交结果，将持久保存在数据库中。

## 基本语法

- `START TRANSACTION` 开启事物
- `COMMIT` 提交事物
- `ROLLBACK` 回滚

## 事务并发的问题

### 第一类丢失更新

在没有事务隔离的情况下，两个事务都同时更新一行数据，但是第二个事务却中途失败退出， 导致对数据的两个修改都失效了。

例如：张三的工资为5000，事务A中获取工资为5000，事务B获取工资为5000，汇入100，并提交数据库，工资变为5100，随后事务A发生异常，回滚了，恢复张三的工资为5000，这样就导致事务B的更新丢失了。

### 脏读

脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。

例如：张三的工资为5000,事务A中把他的工资改为8000,但事务A尚未提交。与此同时，事务B正在读取张三的工资，读取到张三的工资为8000。随后，事务A发生异常，而回滚了事务。张三的工资又回滚为5000。最后，事务B读取到的张三工资为8000的数据即为脏数据，事务B做了一次脏读。

### 不可重复读

是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。

例如：在事务A中，读取到张三的工资为5000，操作没有完成，事务还没提交。与此同时，事务B把张三的工资改为8000，并提交了事务。随后，在事务A中，再次读取张三的工资，此时工资变为8000。在一个事务中前后两次读取的结果并不致，导致了不可重复读。

### 第二类丢失更新

不可重复读的特例。有两个并发事务同时读取同一行数据，然后其中一个对它进行修改提交，而另一个也进行了修改提交。这就会造成第一次写操作失效。 

例如：在事务A中，读取到张三的存款为5000，操作没有完成，事务还没提交。与此同时，事务B，存储1000，把张三的存款改为6000，并提交了事务。随后，在事务A中，存储500，把张三的存款改为5500，并提交了事务，这样事务A的更新覆盖了事务B的更新。

### 幻读

是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。

例如：目前工资为5000的员工有10人，事务A读取所有工资为5000的人数为10人。此时，事务B插入一条工资也为5000的记录。这是，事务A再次读取工资为5000的员工，记录为11人。此时产生了幻读。

## 事务隔离级别

### 并发问题的解决

隔离级别 | 第一类丢失更新 | 脏读 | 不可重复读 | 第二类丢失更新 | 幻读 
---|---|---|---|---|---
READ_UNCOMMITTED（未提交读） | &check; ||||
READ_COMMITTED（已提交读） | &check; | &check;|||
REPEATABLE_READ（可重复读） | &check; | &check; | &check; | &check;|
SERIALIZABLE（可串行化） | &check; | &check; | &check; | &check; | &check;

> `REPEATABLE_READ（可重复读）`是Mysql的默认隔离级别。
>
> `SERIALIZABLE（可串行化）`是最高隔离级别，它会在读取的每一行数据上都加锁，可能会导致大量的超时和锁争用的问题，只有在非常需要确保数据一致性而且可以接受没有并发的情况下，才考虑采用该级别。

## 相关命令

1. 查看当前事务级别：`SELECT @@TX_ISOLATION;`

## 参考

- [Mysql事务处理](https://www.bilibili.com/video/BV1Vt4117783?p=2)
- [Mysql事务，并发问题，锁机制](https://www.cnblogs.com/fidelQuan/p/4549068.html)
- [深入理解Mysql——锁、事务与并发控制](https://juejin.im/entry/5aa9ed73518825558b3da65e)